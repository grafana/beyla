name: Fix OBI submodule CI

on:
  pull_request:
    types: [labeled]

permissions: {}

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:
  triage:
    name: Triage CI failures
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Triage
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "false"
          claude_args: >-
            --max-turns 75
            --allowedTools
            "Bash(cat:*),Bash(gh:*),Bash(grep:*),Bash(head:*),Bash(jq:*),
            Bash(ls:*),Bash(python3:*),Bash(tail:*),Bash(wc:*),
            Glob,Grep,LS,Read,Write,Task,TodoWrite"
          prompt: |
            # Extract CI failure context

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"
            **Repository**: beyla. OBI submodule is in `.obi-src`.

            Your job is to **extract and record** failure information for the next step. Do **not** analyse root causes, suggest fixes, or make code changes. Present facts only — describe **what** failed and **what** the error output says, never **why**.

            ## Steps

            1. **List failed/timed-out workflow runs** for this PR using `gh run list` and `gh pr checks`. Record every failed or timed-out job.

            2. **Inspect workflow definitions**: For each failing workflow, read its YAML file under `.github/workflows/` to understand:
               - Which steps run and in what order.
               - Whether the workflow uploads **artifacts** (look for `actions/upload-artifact`). Note artifact names and what they contain.

            3. **Extract failure context from run logs**: For each failing job, use `gh run view --log-failed` or download logs. Logs are large — use **grep**, **tail**, **head** to extract:
               - Error messages, stack traces, panics.
               - Timeout messages or hung-step indicators.
               - Container crash indicators (CrashLoopBackOff, restart counts, OOMKilled).
               - The specific step name that failed and its exit code.
               - Do **not** load entire log files into context.

            4. **Download and inspect artifacts**: If failing workflows upload artifacts and the artifacts exist for the failed run, download them with `gh run download` and grep/head/tail for errors, panics, failures, and timeouts. Artifacts often contain additional logs not visible in the run output.

            5. **Record OBI submodule SHAs**: This PR likely moves the OBI submodule forward. Record the **old SHA** (on `main`) and **new SHA** (on this branch) using `git diff main -- .obi-src`. These SHAs are critical — the next step uses them to identify which OBI changes introduced breaking changes.

            6. **Write `triage.md`** in the repo root with this structure per failing workflow:

               ```
               ## <Workflow Name> — <Job Name>
               **Status**: failed | timed_out
               **Failed step**: <step name> (exit code <N> | timeout)
               **Artifacts inspected**: <list or "none produced" or "none available">
               **Errors**:
               <extracted error lines, stack traces, panics — with enough surrounding context>
               ```

               At the top of the file, include an **OBI SHAs** section if the submodule changed.

            **Output**: Only create/update **`triage.md`**. No other file changes. No analysis. No root cause discussion.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"

      - name: Upload triage artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: triage
          path: triage.md
          if-no-files-found: error

  plan:
    name: Plan fixes
    needs: triage
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Download triage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: triage

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Plan
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "false"
          claude_args: >-
            --max-turns 30
            --allowedTools
            "Bash(cat:*),Bash(git:*),Bash(grep:*),Bash(head:*),Bash(ls:*),Bash(pwd:*),Bash(tail:*),Bash(wc:*),
            Glob,Grep,LS,Read,Write,Task,TodoWrite"
          prompt: |
            # Root cause analysis and implementation plan

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"

            ## Process

            1. **Read `triage.md`** first — it is your sole source of CI failure context. Do not download CI logs or artifacts; triage has already extracted the relevant errors.
            2. **Identify what changed in OBI**: Triage will include old and new OBI submodule SHAs. Run `git -C .obi-src log OLD_SHA..NEW_SHA --oneline` and targeted diffs (`git -C .obi-src diff OLD_SHA..NEW_SHA -- <file>`) to see exactly what OBI changed. OBI CI passes upstream and Beyla main is stable, so **breaking changes come from these new OBI commits and/or updated vendor packages on the branch**. This OBI diff is the primary input for root cause analysis.
            3. **Analyse root causes** by cross-referencing the OBI changes with triage findings and Beyla source code. Look for a **common issue** affecting multiple workflows to minimise the number of changes needed.
            4. **Cross-reference symbol changes**: When OBI renames, removes, or changes the signature of an exported symbol (function, type, const, struct field), search the Beyla codebase for **all references** to that symbol — including test files, helper packages, and generated test scripts. List every call site that needs updating. Existing tests may reference removed or renamed symbols and must be updated in the plan alongside production code.
            5. **Write `plan.md`** with a clear, ordered implementation plan.

            **Stay under ~25 tool calls.** Read triage.md, then open only the minimal set of source files needed to form the plan. Do not explore the repo broadly.

            ## Deductive reasoning — where changes MUST be

            OBI CI passes for the submodule commit used in this branch. Beyla main CI passes. Therefore, the **only** places that can need changes are:
            - **Beyla's own Go code** (not in `vendor/`, not in `.obi-src/`)
            - **Test synchronisation rules** in `scripts/generate-obi-tests.sh` (BEHAVIORAL_TRANSFORMS, CODE_INJECTIONS)
            - **Beyla-specific test extensions** in `internal/test/beyla_extensions/`

            **NEVER plan changes to `vendor/` or `.obi-src/`.** Those directories contain OBI code; if OBI CI passes, the code is correct by definition.

            ## Diagnostic patterns

            **Test failures — sync before patch:**
            When a Beyla test fails on an assertion, **do not** simply adjust the assertion to make it pass. First, locate the corresponding test in OBI (`.obi-src/`) and compare the failing test block with its upstream version:
            - If the test block (or the specific sub-case / table entry within it) has been **removed** in OBI, the correct fix is to **remove the same block** from Beyla's copy of the test (applying the OBI→Beyla translation rules from `scripts/generate-obi-tests.sh`). Do not patch the assertion.
            - If the test block still exists in OBI but the assertion is now wrong (e.g., a changed return value or behaviour), **then** adjust the assertion to match the new OBI behaviour.
            The general principle is: Beyla's generated tests shadow OBI's tests. When OBI changes a test, Beyla's version should be updated to match — not worked around with a minimal assertion fix that hides the upstream intent.

            **Config struct parity (most common cause of timeouts):**
            Beyla mirrors OBI config structs and uses `pkg/helpers/config/convert.go` (`Convert()`) to copy between them. This converter **panics if the destination struct has an exported field the source does not have** (and vice versa). When OBI adds new config fields, Beyla's mirror must be updated with matching fields (`BEYLA_`-prefixed env tags, matching defaults). A startup panic in k8s-cache manifests as **test timeouts** — the cache process is dead and Beyla never receives K8s metadata, so tests hang rather than showing a panic.

            Known mirror pairs — check these first:
            - `vendor/.../obi/pkg/kube/kubecache/config.go` (OBI) ↔ `cmd/k8s-cache/cfg/config.go` (Beyla)
            - `vendor/.../obi/pkg/obi/config.go` (OBI) ↔ `pkg/beyla/config.go` (Beyla), bridged via `pkg/beyla/config_obi.go`

            To diagnose: compare every exported field in the OBI config struct against the Beyla mirror. Any mismatch will cause a panic at startup.

            **Timeouts:** First check config struct parity (above). Then look for container crashes (panics, CrashLoopBackOff) in triage. A timeout waiting for data usually means a sidecar crashed on startup.

            **RCU CPU stalls** in VM workflows are a known occurrence — note them but do not plan fixes unless there is a clear code cause.

            **Stuck waits:** Tests waiting for metric/cache expiry that never occurs — investigate config, timeout values, or broken expiry logic in Beyla source.

            ## Scope

            Port changes from OBI into Beyla. Do not plan edits to `internal/testgenerated/` (generated); plan changes to `scripts/generate-obi-tests.sh` or Go source instead. No test skipping — address failures at the source. Recommend upstream (OBI) changes if needed; code injections are a last resort.

            ## Output

            Single file **`plan.md`** in repo root with:
            1. **Summary**: Short description of failures and the common root cause(s) identified.
            2. **Changes**: Ordered list of concrete file changes in Beyla only — each with file path, what to change, and why.
            3. **Verification**: Which `make` targets or quick checks the implement step should run after editing (e.g. `make fmt lint`, `go vet ./...`).

            No code changes. Only produce `plan.md`.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"

      - name: Upload plan artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: plan
          path: plan.md
          if-no-files-found: error

  implement:
    name: Implement and push
    needs: plan
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Download triage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: triage

      - name: Download plan artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: plan

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Implement
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "true"
          claude_args: >-
            --max-turns 100
            --allowedTools
            "Bash(cat:*),Bash(date:*),Bash(echo:*),Bash(gh:*),
            Bash(git:*),Bash(go:*),Bash(grep:*),Bash(head:*),Bash(jq:*),
            Bash(ls:*),Bash(make:*),Bash(python3:*),Bash(pwd:*),
            Bash(sort:*),Bash(tail:*),Bash(uniq:*),Bash(wc:*),
            Edit,MultiEdit,Glob,Grep,LS,Read,Write,Task,TodoWrite,
            mcp__github_file_ops__commit_changes,
            mcp__github_file_ops__create_or_update_file"
          prompt: |
            # Implement fixes from plan

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"

            Triage and root cause analysis are already complete. Your only job is to **implement the plan and push**. Do not re-triage, re-analyse failures, download CI logs, or download artifacts.

            ## Inputs

            - **`plan.md`** (repo root) — your implementation spec. Follow it exactly, in order.
            - **`triage.md`** (repo root) — reference only if plan.md directs you to it for additional context.
            - Source code as needed, including `.obi-src/` for reference when porting OBI changes.

            ## Forbidden directories — never modify

            - **`vendor/`** — vendored OBI code; correct by definition if OBI CI passes.
            - **`.obi-src/`** — the OBI submodule.
            - **`internal/testgenerated/`** — generated output; change scripts or extensions instead.

            ## Process

            1. **Read `plan.md`** and implement every item in order.
            2. **Run verification** as specified in plan.md (typically `make fmt lint` or `go vet ./...`). Fix any errors before committing.
            3. **Commit and push** to this PR branch using the commit signing API (no local git push). Post a concise PR comment summarising: what files were changed, what was fixed, and any recommended upstream (OBI) changes noted in the plan.

            ## Rules

            - Do not skip or disable tests — fix the underlying cause.
            - Prefer porting proper fixes from OBI into Beyla over code injections in `scripts/generate-obi-tests.sh`.
            - Read-only git for inspection; use provided tools to commit and push. Do not force-push or change the submodule pointer.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"
