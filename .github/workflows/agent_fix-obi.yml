name: Fix OBI submodule CI

on:
  pull_request:
    types: [labeled]

permissions: {}

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:
  fix-obi:
    name: Analyze and fix OBI CI failure
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: write          # Push fixes to PR branch via commit signing API
      pull-requests: write     # Post PR comments with analysis and findings
      issues: read             # Read issue/PR metadata for context
      id-token: write          # OIDC token exchange for Vault secret retrieval
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Run Claude Code
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          # label_trigger tells the action to only activate when this specific
          # label is added. The workflow on.pull_request.types:[labeled] fires
          # for any label; the job if: and label_trigger both filter to our label.
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          # Enable commit signing so Claude can push fixes to the PR branch
          # directly via the GitHub API (no persist-credentials needed).
          use_commit_signing: "true"
          claude_args: >-
            --max-turns 30
            --allowedTools
            "Bash(cat),Bash(date),Bash(echo),Bash(gh),Bash(git diff),Bash(git log),Bash(git show),Bash(git status),Bash(git submodule),Bash(git rev-parse),Bash(go),Bash(grep),Bash(head),Bash(ls),Bash(make),Bash(pwd),Bash(sort),Bash(tail),Bash(uniq),Bash(wc),Edit,MultiEdit,Glob,Grep,LS,Read,Write,Task,TodoWrite"
          prompt: |
            # Fix OBI submodule CI

            You are analyzing a CI failure on an OBI submodule update PR in the Beyla repository.

            ## Context

            - **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"
            - **Repository**: This repo (beyla). The OBI submodule is in `.obi-src` and is updated by the "Update OBI submodule" workflow (`bot_sync-obi-submodule.yml`), which can fail when upstream introduces breaking changes.
            - **Submodule checkout**: The `.obi-src` submodule has already been checked out recursively. If you need to re-init it, run `git submodule update --init --recursive .obi-src`.

            ## Beyla/OBI integration

            - **Generated tests**: `scripts/generate-obi-tests.sh` runs as part of `make vendor-obi`. It copies, transforms, and merges the OBI test suites with `internal/test/beyla_extensions` into `internal/testgenerated`. **Do not modify files in `internal/testgenerated`** — they are regenerated; change the script or source extensions instead.
            - **Where breaking changes usually land**: OBI introduces breaking changes regularly. These typically require:
              - **Config**: updates in `pkg/beyla/config.go` (and related OBI override logic).
              - **Go symbols**: refactoring to match OBI API/package changes.
            - **Go version and obi-generator**: If the Go version has been upgraded (e.g. in OBI or in Beyla's tooling), a **new version of the obi-generator** may be required. The image is set in the root **`Dockerfile`** via `ARG GEN_IMG` (lines 2–3). The Go version used by the obi-generator is likely defined in **`.obi-src/generator.Dockerfile`** (base image, lines 1–2). Align the obi-generator image with the Go version used for the build/tests.
            - **Static check**: After making changes, run **`make fmt lint`** (or at least **`make lint`**). It must pass as a basic first static check.
            - **Porting from OBI**: Other breakages visible in CI logs should be ported from OBI into Beyla (Beyla follows a similar code structure). Make changes in the context of the Beyla repo and follow Beyla-specific naming. Inspect Beyla/OBI differences documented in `scripts/generate-obi-tests.sh`: **BEHAVIORAL_TRANSFORMS** (env renames, identity, paths; around lines 63–64) and **CODE_INJECTIONS** (path setup, config overrides; around lines 120–121). Consider whether `scripts/generate-obi-tests.sh` needs updating so that it still produces idempotent output for other developers cloning Beyla with the OBI submodule, or whether OBI has drifted so that the transforms and injections need to be updated to match.
            - **CI vs local**: The CI test suite runs multiple long-running workflows on Linux (ARM and x86) with BPF. You may not be able to reproduce complex failures locally. **Rely on the CI logs** rather than re-running the full test suite locally (tests are slow and often need nested virtualization via QEMU, kind clusters, etc.). If needed, run **`make fmt lint`** as a quick static check; only run a single unit test if absolutely necessary. Integration tests are unlikely to complete without an appropriate environment — rely heavily on CI logs and on the **git history of the `.obi-src` submodule** to infer what needs to be ported into Beyla.

            ## Your task

            1. **Understand the failure**: Read the triggering PR's title, body, labels, and recent workflow runs. Use `gh` CLI to list failed workflow runs and download logs. Identify which jobs failed and why (e.g. build, tests, vendoring). Prefer CI logs over local reproduction.

            2. **Inspect the codebase**: Ensure `.obi-src` is present — if it is missing or empty, run `git submodule update --init --recursive .obi-src`. Then run `make fmt lint` as a quick static check; run a single unit test only if necessary. Do not attempt to run the full integration test suite locally.

            3. **Implement a fix**: Based on the failure, implement a minimal fix. Prefer:
               - Code or config changes in this repo (outside `.obi-src`) to adapt to OBI changes — especially `pkg/beyla/config.go` and Go symbol refactoring; do not edit `internal/testgenerated` (see Beyla/OBI integration above). If the failure points to test or transform drift, consider updating `scripts/generate-obi-tests.sh`.
               - If you cannot fix without changing `.obi-src`, describe the required upstream change and add a comment on the PR with your findings and a concrete suggestion (branch/commit to use, or a patch idea).
               - Use the Edit/Write tools to make changes. The workflow will commit and push them to this PR branch automatically so CI can re-run.

            4. **Respond on the PR**: Post a concise summary:
               - What failed and why.
               - What you changed (with file/line references if applicable).
               - What was committed and pushed, or what still needs manual intervention.

            ## Safety constraints

            - You have **read-only** git access (log, diff, show, status). Do NOT attempt git push, git reset, git checkout, or any destructive git operations.
            - Do not modify files in `.obi-src/` — this is a submodule managed upstream.
            - Do not force-push or overwrite the submodule commit.
            - Prefer fixes in the Beyla tree that work with the current OBI submodule commit.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"
