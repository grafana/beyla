name: Fix OBI submodule CI

on:
  pull_request:
    types: [labeled]

permissions: {}

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:
  triage:
    name: Triage CI failures
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Triage
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "false"
          claude_args: >-
            --max-turns 100
            --allowedTools
            "Bash(cat:*),Bash(gh:*),Bash(grep:*),Bash(head:*),Bash(jq:*),
            Bash(ls:*),Bash(tail:*),Bash(wc:*),
            Glob,Grep,LS,Read,Write,Task,TodoWrite"
          prompt: |
            # Triage – extract CI failure clues only

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"
            **Repository**: beyla. OBI submodule is in `.obi-src`.

            Your only job is to gather failure information for the next step. Do **not** make code changes or attempt to fix anything.

            1. Use `gh` to list failed workflow runs and checks for this PR. Identify which jobs failed.
            2. For each failing check, get the logs efficiently: use `gh run view` / `gh run download` or equivalent. Logs are large — use **grep**, **tail**, **head** to extract error messages and stack traces. Do not load entire log files into context.
            3. If failing jobs produce artifacts, download them and inspect only what you need (again: grep/tail/head; artifacts often contain large logs — stay efficient).
            4. Write a single file **`triage.md`** in the repository root with:
               - For each failing check: name, workflow/job, and extracted error messages or clues with enough context to understand what went wrong.
               - One short section per failure; keep each section focused.

            Output: **only** create/update **`triage.md`**. No other file changes. Focus on efficient tool use and minimal turns.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"

      - name: Upload triage artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: triage
          path: triage.md
          if-no-files-found: error

  plan:
    name: Plan fixes
    needs: triage
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Download triage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: triage

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Plan
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "false"
          claude_args: >-
            --max-turns 100
            --allowedTools
            "Bash(cat:*),Bash(git:*),Bash(grep:*),Bash(head:*),Bash(ls:*),Bash(pwd:*),Bash(tail:*),Bash(wc:*),
            Glob,Grep,LS,Read,Write,Task,TodoWrite"
          prompt: |
            # Plan – resolve CI failures (no code changes)

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"

            Your only job is to produce a concrete plan for the next step. Do **not** open large log files, re-run tests, or download CI artifacts. Use only:
            - **triage.md** (in repo root) from the previous step
            - **Source code** of Beyla and the `.obi-src` (OBI) submodule

            Context (use when planning):
            - **Generated tests**: `scripts/generate-obi-tests.sh` generates into `internal/testgenerated`. Do not plan edits to `internal/testgenerated`; plan script or extension changes instead.
            - **Breaking changes** often need: `pkg/beyla/config.go`, Go symbol/API refactors, or semantic conventions changes.
            - **Beyla/OBI**: See `scripts/generate-obi-tests.sh` (BEHAVIORAL_TRANSFORMS, CODE_INJECTIONS) for integration; fixes should be in Beyla only, not in `.obi-src`.

            Write **`plan.md`** in the repository root with:
            - Summary of failures (from triage.md).
            - Ordered list of concrete changes (files, edits, or script updates) to fix them, in Beyla only. No OBI submodule edits.

            Output: **only** create/update **`plan.md`**. No code changes.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"

      - name: Upload plan artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: plan
          path: plan.md
          if-no-files-found: error

  implement:
    name: Implement and push
    needs: plan
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Download triage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: triage

      - name: Download plan artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: plan

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Implement
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "true"
          claude_args: >-
            --max-turns 100
            --allowedTools
            "Bash(cat:*),Bash(date:*),Bash(echo:*),Bash(gh:*),
            Bash(git:*),Bash(go:*),Bash(grep:*),Bash(head:*),Bash(jq:*),
            Bash(ls:*),Bash(make:*),Bash(python3:*),Bash(pwd:*),
            Bash(sort:*),Bash(tail:*),Bash(uniq:*),Bash(wc:*),
            Edit,MultiEdit,Glob,Grep,LS,Read,Write,Task,TodoWrite,
            mcp__github_file_ops__commit_changes,
            mcp__github_file_ops__create_or_update_file"
          prompt: |
            # Implement – fix OBI CI (Beyla only)

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"

            Your only job is to implement the plan and push. Do **not** re-open large log files, re-download CI artifacts, or run the full test suite. Use only:
            - **plan.md** (in repo root) from the previous step
            - If you need extra context: **triage.md** from the first step
            - Source code as needed

            Instructions:
            1. Read **plan.md** and implement every item in Beyla only. Do **not** change the OBI submodule (`.obi-src/`).
            2. Do not modify **`internal/testgenerated`** — it is generated; change the script or extensions instead.
            3. After editing, run **`make fmt lint`** (or at least **`make lint`**) as a quick static check.
            4. Commit your changes and push to this PR branch using the commit signing API (no local git push). Post a concise PR comment: what failed, what you changed (file/line if useful), and what was committed and pushed.

            Safety:
            - Read-only git for inspect; use the provided tools to commit and push. Do not force-push or overwrite the submodule commit.
            - Prefer fixes in the Beyla tree that work with the current OBI submodule commit.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"
