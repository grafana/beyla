name: Fix OBI submodule CI

on:
  pull_request:
    types: [labeled]

permissions: {}

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:
  triage:
    name: Triage CI failures
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Triage
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "false"
          claude_args: >-
            --max-turns 100
            --allowedTools
            "Bash(cat:*),Bash(gh:*),Bash(grep:*),Bash(head:*),Bash(jq:*),
            Bash(ls:*),Bash(python3:*),Bash(tail:*),Bash(wc:*),
            Glob,Grep,LS,Read,Write,Task,TodoWrite"
          prompt: |
            # Triage – extract CI failure clues only

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"
            **Repository**: beyla. OBI submodule is in `.obi-src`.

            Your only job is to gather failure information for the next step. Do **not** make code changes or attempt to fix anything.

            1. Use `gh` to list failed workflow runs and checks for this PR. Identify which jobs failed.
            2. For each failing check, get the logs efficiently: use `gh run view` / `gh run download` or equivalent. Logs are large — use **grep**, **tail**, **head** to extract error messages and stack traces. Do not load entire log files into context.
            3. If failing jobs produce artifacts, download them and inspect only what you need (again: grep/tail/head; artifacts often contain large logs — stay efficient).
            4. Write a single file **`triage.md`** in the repository root with:
               - For each failing check: name, workflow/job, and extracted error messages or clues with enough context to understand what went wrong.
               - One short section per failure; keep each section focused.
               - If this PR updates the OBI submodule: note the **old and new OBI commit SHAs** (from the PR branch: e.g. `git diff main -- .obi-src` or submodule pointer in the diff). The next step will use OBI history since the old SHA to guide porting.

            **How to treat failures:**
            - **Timeouts**: Treat CI job timeouts as indicative of an underlying issue — often a **process crash** rather than a logic bug. K8s integration tests run multiple containers; if a sidecar (e.g. k8s-cache) crashes on startup, the test will time out waiting for data that never arrives. When investigating timeouts, look for **panic traces**, **container restart counts**, and **CrashLoopBackOff** in logs, not only test-level errors. Record in triage.md the job name, any log tail, and whether any containers appear to have crashed. Exception: **RCU CPU stalls** in VM workflows are a known occurrence; note them and label as "RCU CPU stall (VM workflow, known class)" so the plan step can treat them differently if appropriate.
            - **Stuck waits**: Some tests wait for metric or cache expiry. If a job times out or fails because that expiry never happens (test stuck waiting), treat it as a bug: note in triage.md that the test appears to be waiting for expiry that did not occur, so the next step can investigate (e.g. config, timeouts, or broken expiry logic).

            Output: **only** create/update **`triage.md`**. No other file changes. Focus on efficient tool use and minimal turns.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"

      - name: Upload triage artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: triage
          path: triage.md
          if-no-files-found: error

  plan:
    name: Plan fixes
    needs: triage
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Download triage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: triage

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Plan
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "false"
          claude_args: >-
            --max-turns 35
            --allowedTools
            "Bash(cat:*),Bash(git:*),Bash(grep:*),Bash(head:*),Bash(ls:*),Bash(pwd:*),Bash(tail:*),Bash(wc:*),
            Glob,Grep,LS,Read,Write,Task,TodoWrite"
          prompt: |
            # Plan – resolve CI failures (no code changes)

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"

            **Efficiency (stay under ~25 tool calls):** Read **triage.md** first and use it as the main source of truth. Only then open the minimal set of files or run 1–2 git commands (e.g. `git -C .obi-src log OLD..HEAD --oneline`) if triage gives OBI SHAs. Do not explore the repo broadly; do not open large log files, re-run tests, or download CI artifacts. Produce **plan.md** in one focused pass.

            **Inputs:** triage.md (repo root), and only the Beyla / `.obi-src` source files needed to turn triage into a concrete plan.

            ## Deductive reasoning — where changes MUST be

            OBI CI passes for the submodule commit used in this branch. Beyla main CI passes. Therefore, the **only** places that can need changes are:
            - **Beyla's own Go code** (not in `vendor/`, not in `.obi-src/`)
            - **Test synchronisation rules** in `scripts/generate-obi-tests.sh` (BEHAVIORAL_TRANSFORMS, CODE_INJECTIONS)
            - **Beyla-specific test extensions** in `internal/test/beyla_extensions/`

            **NEVER plan changes to `vendor/` or `.obi-src/`.** Those directories contain OBI code; if OBI CI passes, the code in those directories is correct by definition. Patching vendor files is always wrong.

            ## Critical pattern: configutil.Convert panics

            Beyla mirrors OBI config structs with its own types and uses `pkg/helpers/config/convert.go` (`Convert()`) to copy between them. **This converter panics if the destination struct has an exported field that the source struct does not have.** When OBI adds new exported fields to a config struct, Beyla's corresponding mirror struct **must** be updated to add a matching field (with a Beyla-namespaced `env:` tag and a matching default value).

            Known mirror-config pairs — check these first when OBI adds config fields:
            - `vendor/.../obi/pkg/kube/kubecache/config.go` (OBI) ↔ `cmd/k8s-cache/cfg/config.go` (Beyla)
            - `vendor/.../obi/pkg/obi/config.go` (OBI) ↔ `pkg/beyla/config.go` (Beyla), bridged via `pkg/beyla/config_obi.go`

            To diagnose: compare every exported field in the OBI config struct at the new commit against the Beyla mirror. Any field present in OBI but absent in Beyla will cause a panic at startup. A startup panic in k8s-cache will manifest as **test timeouts** (not panics in the test output) because the cache process is dead and Beyla never receives K8s metadata.

            ## Scope

            Port changes from OBI into Beyla. If triage lists old/new OBI SHAs, use `git -C .obi-src log` / `diff` between those SHAs to see what to port; otherwise infer from triage and a few targeted file reads. Do not plan edits to `internal/testgenerated` (generated); plan script or `scripts/generate-obi-tests.sh` (BEHAVIORAL_TRANSFORMS, CODE_INJECTIONS) or `pkg/beyla/config.go` / Go refactors instead. No test skipping; address failures at the source. Recommend upstream (OBI) changes in the plan if needed; code injections in the test generator are a last resort.

            **Triage rules:** Timeouts → first check for config struct parity (see above), then plan a fix. Note RCU CPU stall in VM workflows as known. Stuck metric/cache expiry → plan a fix for expiry or config.

            **Output:** Single file **plan.md** in repo root: (1) short summary of failures, (2) ordered list of concrete changes in Beyla only. No code changes.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"

      - name: Upload plan artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: plan
          path: plan.md
          if-no-files-found: error

  implement:
    name: Implement and push
    needs: plan
    if: >
      github.event.action == 'labeled' &&
      github.event.label.name == 'agent/fix-obi' &&
      github.event.pull_request.head.repo.id == github.repository_id
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Generate files
        run: make prereqs vendor-obi

      - name: Download triage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: triage

      - name: Download plan artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: plan

      - name: Get vault secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@f1614b210386ac420af6807a997ac7f6d96e477a # get-vault-secrets/v1.3.1
        with:
          repo_secrets: |
            ANTHROPIC_API_KEY=anthropic-token:token

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Run Claude Code – Implement
        uses: anthropics/claude-code-action@edd85d61533cbba7b57ed0ca4af1750b1fdfd3c4 # v1.0.55
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.get-github-app-token.outputs.token }}
          label_trigger: agent/fix-obi
          use_sticky_comment: "true"
          use_commit_signing: "true"
          claude_args: >-
            --max-turns 100
            --allowedTools
            "Bash(cat:*),Bash(date:*),Bash(echo:*),Bash(gh:*),
            Bash(git:*),Bash(go:*),Bash(grep:*),Bash(head:*),Bash(jq:*),
            Bash(ls:*),Bash(make:*),Bash(python3:*),Bash(pwd:*),
            Bash(sort:*),Bash(tail:*),Bash(uniq:*),Bash(wc:*),
            Edit,MultiEdit,Glob,Grep,LS,Read,Write,Task,TodoWrite,
            mcp__github_file_ops__commit_changes,
            mcp__github_file_ops__create_or_update_file"
          prompt: |
            # Implement – fix OBI CI (Beyla only)

            **Triggering PR**: #${{ github.event.pull_request.number }} — "${{ github.event.pull_request.title }}"

            Your only job is to implement the plan and push. Do **not** re-open large log files, re-download CI artifacts, or run the full test suite. Use only:
            - **plan.md** (in repo root) from the previous step
            - If you need extra context: **triage.md** from the first step
            - Source code as needed (including `.obi-src` for reference; inspect OBI history from the submodule dir if the plan refers to porting from new OBI commits).

            **Scope:** Prefer porting changes from OBI into Beyla. The PR branch git diff shows the old and new OBI submodule SHAs; use `git -C .obi-src log OLD_SHA..HEAD` and diffs in `.obi-src` to see what changed in OBI and port the relevant fixes into Beyla.

            ## FORBIDDEN — never modify these directories
            - **`vendor/`** — vendored OBI code. If OBI CI passes, vendor code is correct. Patching vendor files is always wrong and will be reverted.
            - **`.obi-src/`** — the OBI submodule. Do not change or re-point it.
            - **`internal/testgenerated/`** — generated output. Change scripts or extensions instead.

            ## Common fix pattern: config struct parity

            Beyla mirrors OBI config structs and uses `pkg/helpers/config/convert.go` to copy between them. **This converter panics at runtime if the destination has an exported field missing from the source.** When OBI adds new config fields, the fix is to add matching fields to Beyla's mirror config struct (with `BEYLA_`-prefixed env tags and matching defaults). Key file pairs:
            - `vendor/.../obi/pkg/kube/kubecache/config.go` ↔ `cmd/k8s-cache/cfg/config.go`
            - `vendor/.../obi/pkg/obi/config.go` ↔ `pkg/beyla/config.go` (via `pkg/beyla/config_obi.go`)

            **Approach (no test skipping):**
            - **Address failures at the source.** Do not implement test skipping or disabling; fix the underlying cause so tests pass.
            - **Upstream (OBI) changes:** If the plan recommends an upstream fix in OBI, say so in the PR comment and describe what should change in OBI; do not skip tests as a workaround.
            - **Temporary patches:** Code injections in `scripts/generate-obi-tests.sh` (e.g. CODE_INJECTIONS) are a **last resort** only; prefer porting the proper fix from OBI into Beyla.

            Instructions:
            1. Read **plan.md** and implement every item in Beyla only.
            2. After editing, run **`make fmt lint`** (or at least **`make lint`**) as a quick static check.
            3. Commit your changes and push to this PR branch using the commit signing API (no local git push). Post a concise PR comment: what failed, what you changed (file/line if useful), what was committed and pushed, and any recommended upstream (OBI) changes.

            Safety:
            - Read-only git for inspect; use the provided tools to commit and push. Do not force-push or overwrite the submodule commit.
            - Prefer fixes in the Beyla tree that work with the current OBI submodule commit.
        env:
          DISABLE_TELEMETRY: "1"
          DISABLE_ERROR_REPORTING: "1"
