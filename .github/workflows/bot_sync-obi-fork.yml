name: Sync OBI fork

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

# Set restrictive permissions at workflow level
permissions: {}

jobs:
  sync-fork:
    name: Sync grafana/opentelemetry-ebpf-instrumentation with upstream
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for create-github-app-token
    steps:
      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@ae92934a14a48b94494dbc06d74a81d47fe08a40 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Sync fork with upstream
        env:
          GITHUB_TOKEN: ${{ steps.get-github-app-token.outputs.token }}
        run: |
          HTTP=$(curl -sS -w '%{http_code}' -o /tmp/merge-upstream.json -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/grafana/opentelemetry-ebpf-instrumentation/merge-upstream \
            -d '{"branch":"main"}')
          if [ "$HTTP" = "200" ]; then
            echo "Fork synced successfully"
            exit 0
          fi
          echo "Merge-upstream failed: HTTP $HTTP"
          cat /tmp/merge-upstream.json
          exit 1
