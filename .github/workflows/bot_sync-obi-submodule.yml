name: Update OBI submodule

on:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

# Set restrictive permissions at workflow level
permissions: {}

jobs:
  update-obi:
    name: Update OBI submodule and open PR
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating commits and pushing branch
      pull-requests: write # Needed for creating PRs
      id-token: write # Required for DockerHub login and create-github-app-token
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          submodules: recursive

      - name: Create branch and update submodule
        run: |
          git checkout -b "update-obi-submodule-${{ github.run_id }}"
          git submodule update --checkout --remote .obi-src

      - name: Get OBI short SHA
        id: obi-sha
        run: |
          echo "sha=$(git -C .obi-src rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Commit submodule update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .obi-src
          git diff --staged --quiet || git commit -m "Update OBI submodule to ${{ steps.obi-sha.outputs.sha }}"

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Login to DockerHub
        uses: grafana/shared-workflows/actions/dockerhub-login@081a366728379fd0426b9cfef190e9a21c2d5418 # dockerhub-login/v1.0.3

      - name: Rebuild BPF and vendor OBI
        run: make vendor-obi

      - name: Get GitHub App token
        id: get-github-app-token
        uses: grafana/shared-workflows/actions/create-github-app-token@580590a644e82e79bb2598bdaba0be245a14dda0 # create-github-app-token/v0.2.2
        with:
          github_app: grafana-beyla-bot

      - name: Create/update PR
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        env:
          GITHUB_TOKEN: ${{ steps.get-github-app-token.outputs.token }}
        with:
          commit-message: "Update OBI submodule to ${{ steps.obi-sha.outputs.sha }}"
          title: "Update OBI submodule to ${{ steps.obi-sha.outputs.sha }}"
          body: |
            Automated update of the OBI (OpenTelemetry eBPF Instrumentation) submodule to the latest commit from grafana/opentelemetry-ebpf-instrumentation main.

            OBI commit: `${{ steps.obi-sha.outputs.sha }}`

            If CI fails due to upstream breaking changes, add the **agent/fix-obi** label to this PR to run the agentic workflow and get suggested fixes.
          base: main
          branch: "update-obi-submodule-${{ github.run_id }}"
          labels: automated-pr
          delete-branch: true
