apiVersion: v1
kind: Service
metadata:
  name: testserver
spec:
  selector:
    app: testserver
  ports:
    - port: 8080
      targetPort: http0
    - port: 8081
      targetPort: http1
    - port: 8082
      targetPort: http2
    - port: 8083
      targetPort: http3
    - port: 50051
      targetPort: grpc
---
apiVersion: v1
kind: Pod
metadata:
  name: testserver
  labels:
    app: testserver
spec:
  shareProcessNamespace: true
  containers:
    - name: testserver
      image: testserver:latest
      ports:
        - containerPort: 8080
          name: http0
        - containerPort: 8081
          name: http1
        - containerPort: 8082
          name: http2
        - containerPort: 8083
          name: http3
        - containerPort: 50051
          name: grpc
      env:
        - name: LOG_LEVEL
          value: "DEBUG"
    - name: autoinstrumenter
      image: autoinstrument:latest
      securityContext:
        privileged: true
      env:
        - name: GOCOVERDIR
          value: "/coverage"
        - name: PRINT_TRACES
          value: "true"
        - name: OPEN_PORT
          value: "${OPEN_PORT}"
        - name: EXECUTABLE_NAME
          value: "${EXECUTABLE_NAME}"
        - name: SERVICE_NAMESPACE
          value: "integration-test"
        - name: METRICS_INTERVAL
          value: "10ms"
        - name: BPF_BATCH_TIMEOUT
          value: "10ms"
        - name: LOG_LEVEL
          value: "DEBUG"
        - name: BPF_DEBUG
          value: "TRUE"
        - name: METRICS_REPORT_TARGET
          value: "true"
        - name: METRICS_REPORT_PEER
          value: "true"
        - name: INTERNAL_METRICS_PROMETHEUS_PORT
          value: "8999"

