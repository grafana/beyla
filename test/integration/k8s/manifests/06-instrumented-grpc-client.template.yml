---
apiVersion: v1
kind: Service
metadata:
  # this is the service name as expected by configs/prometheus-config-promscrape.yml
  name: beyla-pinger
spec:
  selector:
    component: pinger
  ports:
    - port: 8999
      name: prometheus
---
# this file is actually a Go template that needs to be processed before deploying
# Mandatory variables are PodName and TargetURL
apiVersion: v1
kind: Pod
metadata:
  name: "{{.PodName}}"
  labels:
    component: pinger
spec:
  shareProcessNamespace: true
  serviceAccountName: beyla
  volumes:
    - name: configs
      persistentVolumeClaim:
        claimName: configs
    - name: testoutput
      persistentVolumeClaim:
        claimName: testoutput
    - name: maincode
      configMap:
        name: maincode
  containers:
    - name: pinger
      image: grpcpinger:dev
      env:
        - name: TARGET_URL
          value: "{{.TargetURL}}"
    - name: beyla
      image: beyla:dev
      imagePullPolicy: Never # loaded into Kind from localhost
      securityContext:
        privileged: true
      command: [ "/beyla", "--config=/configs/instrumenter-config.yml" ]
      volumeMounts:
        - mountPath: /configs
          name: configs
        - mountPath: /testoutput
          name: testoutput
      ports:
        - containerPort: 8999
      env:
        - name: BEYLA_PROMETHEUS_PORT
          value: "8999"
        - name: GOCOVERDIR
          value: "/testoutput"
        - name: PRINT_TRACES
          value: "true"
        - name: EXECUTABLE_NAME
          value: "grpcpinger"
        - name: METRICS_INTERVAL
          value: "10ms"
        - name: BPF_BATCH_TIMEOUT
          value: "10ms"
        - name: LOG_LEVEL
          value: "DEBUG"
        - name: BPF_DEBUG
          value: "TRUE"
        - name: METRICS_REPORT_TARGET
          value: "true"
        - name: METRICS_REPORT_PEER
          value: "true"
        - name: KUBE_METADATA_ENABLE
          value: "true"
